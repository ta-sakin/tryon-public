console.log("Content script loaded for AI Try-On Assistant");const g=t=>{var a;if(t.tagName.toLowerCase()!=="img")return!1;const e=t;console.log("Checking image:",{src:e.src,id:e.id,classes:e.className,closest:{dataAsin:(a=e.closest("[data-asin]"))==null?void 0:a.getAttribute("data-asin"),imgTagWrapper:!!e.closest(".imgTagWrapper"),dynamicImage:!!e.closest(".a-dynamic-image")}});const r=window.getComputedStyle(e);if(r.display==="none"||r.visibility==="hidden"||r.opacity==="0")return console.log("Image is hidden"),!1;const o=e.getBoundingClientRect();if(o.width<100||o.height<100)return console.log("Image is too small:",{width:o.width,height:o.height}),!1;if(window.location.hostname.includes("amazon")){const n=e.closest("[data-asin]")!==null||e.classList.contains("s-image")||e.id==="landingImage"||e.id==="imgBlkFront"||e.hasAttribute("data-old-hires")||e.hasAttribute("data-a-dynamic-image")||e.closest(".imgTagWrapper")!==null||e.closest(".a-dynamic-image")!==null||e.closest(".image-block")!==null||e.closest("[data-action='main-image-click']")!==null||e.closest("[data-component-type='s-product-image']")!==null;return console.log("Amazon product image check:",n),n}return!0},m=t=>{if(window.location.hostname.includes("amazon")){const e=[t.getAttribute("data-old-hires"),t.getAttribute("data-a-dynamic-image"),t.getAttribute("data-zoom-hires"),t.src];if(console.log("Available image sources:",e),e[1])try{const o=JSON.parse(e[1]),a=Object.keys(o);if(a.length>0){const n=a.sort((i,c)=>{const[l]=o[i],[d]=o[c];return d-l})[0];return console.log("Found highest resolution URL:",n),n}}catch(o){console.warn("Failed to parse dynamic image data:",o)}const r=e.find(o=>o)||t.src;return console.log("Using image source:",r),r}return t.src},u=t=>{try{chrome.storage.local.set({selectedImage:t},()=>{if(chrome.runtime.lastError){console.warn("Failed to save image:",chrome.runtime.lastError);return}chrome.runtime.sendMessage({type:"OPEN_POPUP",imageUrl:t},e=>{chrome.runtime.lastError&&(console.warn("Failed to open popup:",chrome.runtime.lastError),chrome.storage.local.set({selectedImage:t}))})})}catch(e){console.warn("Extension context may be invalidated, reloading page...",e),window.location.reload()}},s=t=>{const e=t.target;e.tagName.toLowerCase()==="img"&&chrome.storage.local.get(["enabledTryOn"],r=>{try{chrome.runtime.lastError&&console.log("chrome.runtime.lastError",chrome.runtime.lastError);const{enabledTryOn:o}=r;if(!o)return;if(console.log("Click event detected"),console.log("Image clicked, checking if product image..."),g(e)){const n=m(e);console.log("✅ Valid product image selected:",n),u(n),t.preventDefault(),t.stopPropagation()}else console.log("❌ Not a valid product image")}catch(o){console.log("error getting items",o)}})};try{document.addEventListener("click",s)}catch(t){console.warn("Failed to add click listener:",t)}window.addEventListener("unload",()=>{try{document.removeEventListener("click",s)}catch(t){console.log(t)}});function h(){if(!window.location.hostname.includes("amazon"))return;const t=document.createElement("button");t.id="tryon-overlay-btn",t.innerHTML=`
  <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; background: #5C64C7; color: white; 
  padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; align-items: center; 
  font-family: 'Inter', sans-serif; font-size: 14px; cursor: pointer;">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
  <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
  </svg>
  Try it on
  </div>
  `,document.body.appendChild(t);let e=!1;chrome.storage.local.get(["enabledTryOn"],r=>{try{chrome.runtime.lastError&&console.log("chrome.runtime.lastError",chrome.runtime.lastError),e=r.enabledTryOn,t.querySelector("div").style.background=e?"#FF9800":"#5C64C7"}catch(o){console.log("error getting items",o)}}),t.addEventListener("click",()=>{e=!e,chrome.storage.local.set({enabledTryOn:e}),e?t.querySelector("div").style.background="#FF9800":t.querySelector("div").style.background="#5C64C7"})}h();
