console.log("Content script loaded for AI Try-On Assistant");const m=e=>{var n;if(e.tagName.toLowerCase()!=="img")return!1;const t=e;console.log("Checking image:",{src:t.src,id:t.id,classes:t.className,closest:{dataAsin:(n=t.closest("[data-asin]"))==null?void 0:n.getAttribute("data-asin"),imgTagWrapper:!!t.closest(".imgTagWrapper"),dynamicImage:!!t.closest(".a-dynamic-image")}});const i=window.getComputedStyle(t);if(i.display==="none"||i.visibility==="hidden"||i.opacity==="0")return console.log("Image is hidden"),!1;const o=t.getBoundingClientRect();if(o.width<100||o.height<100)return console.log("Image is too small:",{width:o.width,height:o.height}),!1;if(window.location.hostname.includes("amazon")){const r=t.closest("[data-asin]")!==null||t.classList.contains("s-image")||t.id==="landingImage"||t.id==="imgBlkFront"||t.hasAttribute("data-old-hires")||t.hasAttribute("data-a-dynamic-image")||t.closest(".imgTagWrapper")!==null||t.closest(".a-dynamic-image")!==null||t.closest(".image-block")!==null||t.closest("[data-action='main-image-click']")!==null||t.closest("[data-component-type='s-product-image']")!==null;return console.log("Amazon product image check:",r),r}return!0},u=e=>{if(window.location.hostname.includes("amazon")){const t=[e.getAttribute("data-old-hires"),e.getAttribute("data-a-dynamic-image"),e.getAttribute("data-zoom-hires"),e.src];if(console.log("Available image sources:",t),t[1])try{const o=JSON.parse(t[1]),n=Object.keys(o);if(n.length>0){const r=n.sort((l,c)=>{const[d]=o[l],[g]=o[c];return g-d})[0];return console.log("Found highest resolution URL:",r),r}}catch(o){console.warn("Failed to parse dynamic image data:",o)}const i=t.find(o=>o)||e.src;return console.log("Using image source:",i),i}return e.src},y=e=>{try{chrome.storage.local.set({selectedImage:e},()=>{if(chrome.runtime.lastError){console.warn("Failed to save image:",chrome.runtime.lastError);return}chrome.runtime.sendMessage({type:"OPEN_POPUP",imageUrl:e},t=>{chrome.runtime.lastError&&(console.warn("Failed to open popup:",chrome.runtime.lastError),chrome.storage.local.set({selectedImage:e}))})})}catch(t){console.warn("Extension context may be invalidated, reloading page...",t),window.location.reload()}};let s=!0;const a=e=>{const t=e.target;if(t.tagName.toLowerCase()==="img")try{if(!s)return;if(console.log("Click event detected"),console.log("Image clicked, checking if product image..."),m(t)){const o=u(t);console.log("✅ Valid product image selected:",o),y(o),e.preventDefault(),e.stopPropagation()}else console.log("❌ Not a valid product image")}catch(i){console.log("error getting items",i)}};try{document.addEventListener("click",a)}catch(e){console.warn("Failed to add click listener:",e)}window.addEventListener("unload",()=>{try{document.removeEventListener("click",a)}catch(e){console.log(e)}});function h(){if(!window.location.hostname.includes("amazon"))return;const e=document.createElement("button");e.id="tryon-overlay-btn",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="9999",e.style.border="none",e.style.background="none",e.style.padding="0",e.style.opacity="0.6",e.innerHTML=`
  <div style="visibility: hidden; position: relative; color: white; 
  padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; align-items: center; 
  font-family: 'Inter', sans-serif; font-size: 14px; cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
      <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
    </svg>
    Try it on
    <div id="cross-button" style="visibility: hidden; position: absolute; top: -12px; left: -12px; cursor: pointer; 
    background-color: black; color: white; width: 24px; height: 24px; border-radius: 50%; 
    font-size: 14px; display: flex; align-items: center; justify-content: center;">
   ✕</div>
  </div>
  `,document.body.appendChild(e);const t=e.querySelector("#cross-button"),i=e.querySelector("div");chrome.storage.local.get(["tryonButtonVisible"],o=>{const n=o.tryonButtonVisible!==void 0?o.tryonButtonVisible:!0;e.style.display=n?"block":"none"}),e.addEventListener("mouseenter",()=>{e.style.opacity="1"}),i.addEventListener("mouseleave",()=>{e.style.opacity="0.6"}),i.addEventListener("mouseenter",()=>{t.style.visibility="visible"}),i.addEventListener("mouseleave",()=>{t.style.visibility="hidden"}),t.addEventListener("click",o=>{o.stopPropagation(),e.style.display="none",chrome.storage.local.set({tryonButtonVisible:!1})}),chrome.storage.local.get(["enabledTryOn"],o=>{try{chrome.runtime.lastError&&console.log("chrome.runtime.lastError",chrome.runtime.lastError),s=o.enabledTryOn??s,i.style.background=s?"#FF9800":"gray",i.style.visibility="visible"}catch(n){console.log("error getting items",n)}}),e.addEventListener("click",()=>{s=!s,chrome.storage.local.set({enabledTryOn:s}),i.style.background=s?"#FF9800":"gray"})}h();
